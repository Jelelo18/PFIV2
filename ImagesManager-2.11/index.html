<!--------------------------------------------------------------------------------------------------
    Single Page Application
    NEWS MANAGER WEB CLIENT

    LAST UPDATE: december 2021
    Authors: Nicolas Chourot / Jerome Laurence
    Lionel-Groulx College
----------------------------------------------------------------------------------------------------->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta author="Nicolas Chourot / Jerome Laurence">
    <meta http-equiv="Content-Type" content="text/html; charset= ISO-8859-1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Gestionnaire de nouvelles</title>

    <!---STYLES BUNDLE -------------------------------------------------------------------------->
    <link rel="stylesheet" href="css/jquery-ui.css">
    <link rel="icon" href="favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- TOOLTIPS STYLE -->
    <link rel="stylesheet" href="css/tooltip.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- CONFIRM DIALOG STYLE -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">

    <!-- FONT AWESOME STYLES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- NEWS MANAGER MAIN LAYOUT STYLE -->
    <link rel="stylesheet" href="css/photosManagerLayout.css">

    <!-- favicon link: use https://favicon.io/favicon-converter/ to create new favicon -->

    <!---PAGE BACKGROUND IMAGE------------------------------------------------------------------>
    <style>
        body {
            background: url(images/city.jpg) no-repeat center center fixed;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>

    <!---NEWS MANAGER UI CONTAINER--------------------------------------------------------->
    <!---NAVBAR------------------------------------------------------->
    <div>
        <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #ffffff;" id="customNavbar">
            <img src="./images/favicon.png" style="height: 60px; border-radius: 8px; margin-left: 5px;">
            <a class="navbar-brand" href="index.html"
                style="margin-left: 0px; font-family: Verdana, Geneva, Tahoma, sans-serif; color: black; font-weight: 700; margin-left: 10px;">News
            </a>

            <span id="addNewsBtn" class="fa fa-plus" style="font-size: 3em; color: green; cursor: pointer; margin-left: 10px;"></span>

            <form class="navbar-form"
                style="display: flex; flex-direction: row; align-items: center; margin-left: 100px;">
                <div class="form-group">
                    <input type="search" id="form1" class="form-control" placeholder="Recherche par auteur"
                        style="border-radius: 5px 0px 0px 5px;" />
                </div>
                <button type="button" class="btn" style="margin-left: 0px; border-radius: 0px 5px 5px 0px;">
                    <i class="fa fa-search" style="font-size: 20px"></i>
                </button>
                <div class="form-group" style="margin-left: 15px;">
                    <input type="search" id="form1" class="form-control" placeholder="Recherche par mots-clés"
                        style="border-radius: 5px 0px 0px 5px;" />
                </div>
                <button type="button" class="btn" style="margin-left: 0px; border-radius: 0px 5px 5px 0px;">
                    <i class="fa fa-search" style="font-size: 20px"></i>
                </button>
            </form>

            <ul class="nav navbar-nav navbar-right" style="float: right;">

                <!-- CONTAINER WRAPPER -->
                <div id="avatarContainer"></div>
                <h5 id="username">
                    </h1>
                    <button type="button" class="btn btn-light" style="min-width: 20px; margin-left: 150px;"
                        id="btn_OpenLoginForm">
                        <i class="fa fa-sign-in" aria-hidden="true" style="font-size: 20px;"></i>
                    </button>
                    <button type="button" class="btn btn-light" style="min-width: 20px; margin-left: 150px;"
                        id="btn_OpenConfirmLogout">
                        <i class="fa fa-sign-in" aria-hidden="true" style="font-size: 20px;"></i>
                    </button>
                    <button type="button" class="btn"
                        style="min-width: 20px; margin-left: 5px; background-color: #ffffff;" id="btn_OpenProfilDialog">
                        <i class="fa fa-user" aria-hidden="true" style="font-size: 20px;"></i>
                    </button>
            </ul>
        </nav>

        <!---NEWS LIST HEAD----------------------------------------------------------->
        <div class="header-container">
        </div>

        <!---NEWS LIST----------------------------------------------------------------->
        <div class="news-list-scroll-containter">
            <div class="news-list-container" id="newsList">
                <!-- La liste de nouvelles sera injectée ici par du JavaScript -->
            </div>
        </div>
    </div>

    <!---NEWS DIALOG------------------------------------------------------------------------>
    <div style="display: none;" id="dialog-newsForm" title="news" class="dialog">
        <form id="newsForm" class="form-group">
            <input type="hidden" id="newsId" />
            <input type="hidden" id="newsUserId" />
            <input type="hidden" id="newsGUID" />
            <input type="hidden" id="newsCreated" />
            <input type="text" id="newsTitle" placeholder="Titre" class="form-control" />

            <div style="vertical-align:top; text-align: center ">
                <div class='imageDownloader' id='news' defautImageSrc='images/No_image.png'></div>
                <label>(cliquez pour la changer l'image)</label>
            </div>
            <textarea id="newsText" placeholder="Texte" class="form-control">
            </textarea>
        </form>
    </div>

    <!---LOGIN DIALOG--------------------------------------------------------------------------->
    <div style="display: none;" id="dialog-loginForm" title="Connexion" class="dialog">
        <form id="loginForm" class="form-group">
            <input type="text" id="loginEmail" placeholder="Courriel" class="form-control" />
            <input type="password" id="loginPassword" placeholder="Mot de passe" class="form-control" />
            <br>
            <div class="form-group form-check">
                <input type="checkbox" class="form-check-input" id="remember-me">
                <label class="form-check-label" for="remember-me">Se souvenir de moi</label>
            </div>
        </form>
    </div>

    <!---PROFIL DIALOG-------------------------------------------------------------------------->
    <div style="display: none;" id="dialog-profilForm" title="Profil" class="dialog">
        <form id="profilForm" class="form-group">
            <input type="hidden" id="avatarGUID" />
            <input type="hidden" id="profilId" />
            <input type="text" id="profilUsername" placeholder="Nom d'usager" class="form-control" />
            <input type="text" id="profilEmail" placeholder="Courriel" class="form-control" />
            <input type="password" id="profilPassword" placeholder="Mot de passe" class="form-control" />
            <br>
            <input type="password" id="profilConfirmPassword" placeholder="Confirmation" class="form-control" />
            <br>
            <div style="vertical-align:top; text-align: center ">
                <div class='imageDownloader' id='avatar' defautImageSrc='images/No_Avatar.png'></div>
                <label>(cliquez pour la changer l'avatar)</label>
            </div>
        </form>
    </div>

    <!---WAITING DIALOG-------------------------------------------------------------------------->
    <div style="display: none;" id="dialog-waiting" title="" class="dialog">
        <img src="images/writing.gif" alt="waiting" />
    </div>

    <!---SCRIPTS BUNDLE------------------------------------------------------------------------->
    <script src="js/jquery-3.5.1.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/Validation.js"></script>
    <script src="js/WebAPIRequest.js"></script>
    <script src="js/jquery-confirm.js"></script>
    <script src="js/jquery.maskedinput.js"></script>
    <script src="js/imageUploadUtilities.js"></script>

    <!---photo MANAGER UI SCRIPT------------------------------------------------------------->
    <script>
        "use strict";

        $(document).ready(initUI);

        let editMode = false;
        let addMode = false;
        let editProfil = false;
        let connected = false;
        let queryString = "";
        let search = "";
        let searchShowed = false;
        let sorted = [{ field: "Created", desc: true }];
        let currentETag = "";
        let previousQueryString = "";
        let newsValidationProvider = null;
        let profilValidationProvider = null;
        let pausephotosListPeriodicRefresh = false;
        let periodicRefreshPeriod = 5; // seconds

        function initUI() {
            initNewsValidation();
            initProfilValidation();

            initNewsDialog();
            initLoginDialog();
            initProfilDialog();

            $(".searchBar").hide();
            $('#addNewsBtn').click(OpenAddNewsDialog);
            $("#btn_OpenLoginForm").click(OpenLoginForm);
            $("#btn_OpenConfirmLogout").click(OpenConfirmLogout);
            $("#btn_OpenProfilDialog").click(OpenProfilDialog);

            $('#showSearch').click(toogleSearchVisibility);

            $("#sort_Title").click(updateSort);
            $("#sort_Created").click(updateSort);
            $("#sort_Username").click(updateSort);

            $("input[type=search").on("input", updatePhotosSearch);
            $("#dialog-waiting").dialog({
                autoOpen: false,
                show: { effect: 'fade', duration: 400 },
                hide: { effect: 'fade', duration: 400 },
                width: "200px"
            });
            insertWaitingStatus();
            initphotosListColumnsLayout();

            updatePhotosSearch();
            installPeriodicphotosListRefresh();
        }

        function installPeriodicphotosListRefresh() {
            setInterval(() => {
                if (!pausephotosListPeriodicRefresh & connected) getphotos();
            }, periodicRefreshPeriod * 1000);
        }
        function initphotosListColumnsLayout() {
            createCssClass('.columns-layout', "display: grid; grid-template-columns: 30% 30% 30% 5% 5%;");
        }

        function initNewsDialog() {
            $("#dialog-newsForm").dialog({
                autoOpen: false,
                show: { effect: 'fade', duration: 400 },
                hide: { effect: 'fade', duration: 400 },
                buttons: [
                    {
                        id: 'btn-Savenews',
                        text: 'Soumettre',
                        click: function () {

                            // Ajout d'une nouvelle
                            if (addMode) {
                                let news = makeNewsFromNewsForm(false);
                                if (newsValidationProvider.isValid()) {
                                    $("#dialog-waiting").dialog('open');
                                    $("#dialog-newsForm").dialog("close");
                                    webAPI_POST(news, () => { updateUI(); }, AlertError);
                                }
                            } else {
                                let photo = makeNewsFromNewsForm(true);
                                if (newsValidationProvider.isValid()) {
                                    $("#dialog-waiting").dialog('open');
                                    $("#dialog-newsForm").dialog("close");
                                    webAPI_PUT(news, () => { updateUI(); }, AlertError);
                                }
                            }
                        }
                    },
                    {
                        id: 'btn-Cancelnews',
                        text: 'Annuler',
                        click: function () {
                            $(this).dialog('close');
                        }
                    }
                ]
            });
            $('#dialog-newsForm').on('dialogopen', function (event) {
                pausephotosListPeriodicRefresh = true;
                $('#btn-Savenews').addClass("btn btn-primary");
                $('#btn-Cancelnews').addClass("btn btn-secondary");
                $('#newsTitle').val("");
                $('#newsText').val(""); // todo set UserId field
                clearImageData('news');

                /// Tres important si on veut que la photo par defaut soit affichée dans le dialogue
                setImageDownloaderBlankImage('news');
                $("#newsUserId").val(retrieveLoggedUser().Id);
                $("#btn_OpenAddNewsDialog").hide();
            });
            $('#dialog-newsForm').on('dialogclose', function (event) {
                addMode = false;
                editMode = false;
                pausephotosListPeriodicRefresh = false;
                resetphotoValidation();
                $("#btn_OpenAddNewsDialog").show();
            });
        }
        function operationOnGoing() {
            return addMode || editMode || editProfil;
        }
        function OpenAddNewsDialog() {
            if (!operationOnGoing()) {
                addMode = true;
                $('#dialog-newsForm').dialog('option', 'title', 'Ajout de publication');
                $("#dialog-newsForm").dialog('open');
            }
        }
        function OpenEditNewsDialog(e) {
            e.preventDefault();
            if (!operationOnGoing()) {
                editMode = true;
                $('#dialog-newsForm').dialog('option', 'title', 'Modification de la publication');
                $("#dialog-newsForm").dialog('open');
                let newsId = e.currentTarget.id.split('_')[1];
                webAPI_GET(newsId, fillEditNewsForm, AlertError);
            }
        }
        function fillEditNewsForm(news) {
            $('#newsId').val(news.Id);
            $('#newsUserId').val(news.UserId);
            $('#newsGUID').val(news.GUID);
            $('#newsTitle').val(news.Title);
            $('#newsCreated').val(news.Created);
            $('#newsText').val(news.Text);
            clearImageData('news');
            if (news.ImageURL != "")
                /// Tres important si on veut que la photo soit affichée dans le dialogue
                setImageDownloaderImage('news', news.ImageURL);
            else
                setImageDownloaderBlankImage('news');
            //<div class='imageDownloader' id = 'photo' defautImageSrc='images/No_image.png'></div>
        }

        function makeNewsFromNewsForm(includeId = false) {
            if (includeId) {
                // Récupération du Id du photo dans le contrôle caché
                return {
                    Id: parseInt($('#newsId').val()),
                    Title: $('#newsTitle').val(),
                    ImageData: getImageData('news'),
                    Text: $('#newsText').val(),
                    Created: parseInt($('#newsCreated').val()),
                    GUID: $('#newsGUID').val(),
                    UserId: parseInt($('#newsUserId').val())
                };
            }
            return {
                Id: 0,
                Title: $('#newsTitle').val(),
                ImageData: getImageData('news'),
                Text: $('#newsText').val(),
                Created: parseInt($('#newsCreated').val()),
                GUID: $('#newsGUID').val(),
                UserId: parseInt($('#newsUserId').val())
            };
        }
        function deletephoto(e) {
            e.preventDefault();
            if (!operationOnGoing()) {
                // Extraction du Id du photo inscrit dans l'attribut id de l'élément déclencheur de l'événement click
                let photoId = parseInt(e.currentTarget.id.split('_')[1]);
                webAPI_GET(photoId, confirmDeletephoto, AlertError);
            }
        }
        function confirmDeletephoto(photo) {
            $.confirm({
                title: 'Retrait de photos',
                content: '<b>' + photo.Title + '</b>?',
                buttons: {
                    confirmer: function () {
                        $("#dialog-waiting").dialog('open');
                        webAPI_DELETE(photo.Id, updateUI, AlertError);
                    },
                    annuler: {},
                }
            });
        }

        function initProfilDialog() {
            $("#dialog-profilForm").dialog(
                {
                    autoOpen: false,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    buttons: [
                        {
                            id: 'btn-SaveProfil',
                            text: 'Enregister',
                            click: function () {
                                if (profilValidationProvider.isValid()) {
                                    let profilFromForm = {
                                        Id: parseInt($("#profilId").val()),
                                        Name: $("#profilUsername").val(),
                                        Email: $("#profilEmail").val(),
                                        Password: $("#profilPassword").val(),
                                        AvatarGUID: $("#avatarGUID").val(),
                                        ImageData: getImageData('avatar')
                                    }
                                    $("#dialog-waiting").dialog('open');
                                    if (connected) {
                                        webAPI_ChangeProfil(profilFromForm, () => { $("#dialog-profilForm").dialog("close"); updateUI(); }, AlertError);
                                    }
                                    else {
                                        profilFromForm.Id = 0;
                                        webAPI_Register(profilFromForm, () => { $("#dialog-profilForm").dialog("close"); updateUI(); }, AlertError);
                                    }
                                }
                            }
                        },
                        {
                            id: 'btn-CancelProfil',
                            text: 'Annuler',
                            click: function () {
                                $(this).dialog('close');
                            }
                        },
                        {
                            id: 'btn-deleteProfil',
                            text: 'Désinscription',
                            click: function () {
                                confirmDeleteAccount();
                            }
                        }
                    ]
                });
            $('#dialog-profilForm').on('dialogopen', function (event) {
                pausephotosListPeriodicRefresh = true;
                resetProfilValidation();
                $("#profilId").val(0);
                $('#btn-SaveProfil').addClass("btn btn-primary");
                $('#btn-deleteProfil').addClass("btn btn-danger");
                $('#btn-CancelProfil').addClass("btn btn-secondary");
                if (connected) {
                    $('#dialog-profilForm').dialog('option', 'title', 'Modification de votre profil...');
                    $("#profilId").val(retrieveLoggedUser().Id);
                    $('#profilUsername').val(retrieveLoggedUser().Name);
                    $('#profilEmail').val(retrieveLoggedUser().Email);
                    $('#avatarGUID').val(retrieveLoggedUser().AvatarGUID);
                    if (retrieveLoggedUser().AvatarURL != "")
                        setImageDownloaderImage('avatar', retrieveLoggedUser().AvatarURL);
                    else
                        setImageDownloaderBlankImage('avatar');
                    $('#btn-deleteProfil').show();
                } else {
                    $('#dialog-profilForm').dialog('option', 'title', 'Création de compte...');
                    $('#profilUsername').val("");
                    $('#profilEmail').val("");
                    setImageDownloaderBlankImage('avatar');
                    $('#btn-deleteProfil').hide();
                }
                $('#profilPassword').val("");
                $('#profilConfirmPassword').val("");
                $("#btn_OpenAddphotoDialog").hide();
            });
            $('#dialog-profilForm').on('dialogclose', function (event) {
                pausephotosListPeriodicRefresh = false;
                editProfil = false;
                if (connected)
                    $("#btn_OpenAddphotoDialog").show();
            });
        }
        function OpenProfilDialog() {
            if (!operationOnGoing()) {
                pausephotosListPeriodicRefresh = true;
                editProfil = true;
                $("#dialog-profilForm").dialog('open');
            }
        }
        function confirmDeleteAccount() {
            pausephotosListPeriodicRefresh = true;
            $.confirm({
                title: 'Retrait de compte',
                content: '<b>Voulez-vous vraiment effacer votre compte <br>ainsi que toutes vos photos?</b>',
                buttons: {
                    confirmer:
                        function () {
                            if (connected) {
                                webAPI_DELETE_Account(retrieveLoggedUser().Id,
                                    function () {
                                        closeAllDialog();
                                        pausephotosListPeriodicRefresh = false;
                                        forceLogout();
                                    },
                                    AlertError);
                            }
                        },
                    annuler: {},
                }
            });
        }

        function initLoginDialog() {
            $("#dialog-loginForm").dialog(
                {
                    autoOpen: false,
                    show: { effect: 'fade', speed: 400 },
                    hide: { effect: 'fade', speed: 400 },
                    buttons: [
                        {
                            id: 'btn-OkLogin',
                            text: 'Ok',
                            click: function () {
                                pausephotosListPeriodicRefresh = false;
                                $("#dialog-waiting").dialog('open');
                                webAPI_login($("#loginEmail").val(),
                                    $("#loginPassword").val(),
                                    () => {
                                        $("#dialog-loginForm").dialog("close");
                                        updateUI();
                                    },
                                    failLogin);
                            }
                        },
                        {
                            id: 'btn-CancelLogin',
                            text: 'Annuler',
                            click: function () {
                                $(this).dialog('close');
                            }
                        }
                    ]
                });
            $('#dialog-loginForm').on('dialogopen', function (event) {
                pausephotosListPeriodicRefresh = true;
                if (localStorage.getItem('rememberme') == "1") {
                    $("#remember-me").attr("checked", "checked");
                    let email = localStorage.getItem('loginemail');
                    let password = localStorage.getItem('loginpassword');
                    if (email) $("#loginEmail").val(email);
                    if (password) $("#loginPassword").val(password);
                } else {
                    $("#loginEmail").val("");
                    $("#loginPassword").val("");
                }
            });
            $('#dialog-loginForm').on('dialogclose', function (event) {
                pausephotosListPeriodicRefresh = false;
                if ($('#remember-me').is(":checked")) {
                    localStorage.setItem('rememberme', "1");
                    localStorage.setItem('loginemail', $("#loginEmail").val());
                    localStorage.setItem('loginpassword', $("#loginPassword").val());
                } else {
                    localStorage.setItem('rememberme', "0");
                    localStorage.removeItem('loginemail');
                    localStorage.removeItem('loginpassword');
                }
            });
        }
        function OpenConfirmLogout() {
            if (!operationOnGoing()) {
                $.confirm({
                    title: 'Déconnection...',
                    content: 'Voulez-vous vous déconnecter?',
                    buttons: {
                        confirmer: function () {
                            pausephotosListPeriodicRefresh = false;
                            webAPI_logout(retrieveLoggedUser().Id, updateUI, AlertError);
                        },
                        annuler: {},
                    }
                });
            }
        }
        function OpenLoginForm() {
            if (!operationOnGoing()) {
                $('#btn-OkLogin').addClass("btn btn-primary");
                $('#btn-CancelLogin').addClass("btn btn-secondary");
                $("#dialog-loginForm").dialog('open');
            }
        }
        function setUsername(username) {
            $("#username").html("<span id='link_OpenProfilDialog' style='color:blue;' tooltip='Modifier votre profil' class='clickable'>" + username + "</span>");
            $("#link_OpenProfilDialog").click(OpenProfilDialog);
        }
        function unsetUsername() {
            $("#username").html("<span style='color:gray'>non connecté</span>");
        }
        function failLogin() {
            Alert("Connexion échouée");
            connected = false;
            unsetUsername();
            updateUI();
        }
        function updateConnected() {
            connected = false;
            let username = "";
            if (retrieveLoggedUser() != null) {
                username = retrieveLoggedUser().Name;
                connected = true;
            }
            if (connected) {
                setUsername(username);
                $("#avatarContainer").empty();
                $("#avatarContainer").append(html_fittedAvatar(retrieveLoggedUser().AvatarURL, 'avatar'));
                $("#btn_OpenLoginForm").hide();
                $("#btn_OpenConfirmLogout").show();
                $("#btn_OpenConfirmLogout").css("background-color", "red");
                $("#btn_OpenAddphotoDialog").show();
                $('#btn_OpenProfilDialog').attr("tooltip", "Profil");
            }
            else {
                $("#avatarContainer").empty();
                unsetUsername();
                $("#btn_OpenLoginForm").show();
                $("#btn_OpenLoginForm").css("background-color", "green");
                $("#btn_OpenConfirmLogout").hide();
                $("#btn_OpenAddphotoDialog").hide();
                $('#btn_OpenProfilDialog').attr("tooltip", "Création de compte");
            }
        }

        function toogleSearchVisibility() {
            if (searchShowed)
                hideSearch();
            else
                showSearch();
            searchShowed = !searchShowed;
        }
        function hideSearch() {
            $(".searchBar").hide({ duration: 400 });
            $("#showSearchIcon").removeClass("glyphicon glyphicon-zoom-out");
            $("#showSearchIcon").addClass("glyphicon glyphicon-zoom-in");
        }
        function showSearch() {
            $(".searchBar").show({ duration: 400 });
            $("#showSearchIcon").removeClass("glyphicon glyphicon-zoom-in");
            $("#showSearchIcon").addClass("glyphicon glyphicon-zoom-out");
        }
        function updateSort(e) {
            let name = e.target.id.split('_')[1];
            $("#dir_" + name).removeClass("glyphicon glyphicon-sort-by-attributes");
            $("#dir_" + name).removeClass("glyphicon glyphicon-sort-by-attributes-alt");
            let found = false;
            for (let i = 0; i < sorted.length; i++) {
                if (sorted[i].field == name) {
                    found = true;
                    if (sorted[i].desc)
                        sorted.splice(i, 1);
                    else
                        sorted[i].desc = true;
                    break;
                }
            }
            if (!found)
                sorted.push({ field: name, desc: false });
            updatePhotosSearch();
        }
        function addSearchKey(key, value) {
            if (value != "") {
                if (search != "") search += "&";
                search += key + "=" + value + "*";
            }
        }

        function updatePhotosSearch() {
            queryString = "";
            let first = true;
            let sortIndex = 0;
            sorted.forEach(sort => {
                console.log(sort)
                if (first) {
                    first = false;
                    queryString += '?';
                }
                else queryString += '&';
                queryString += "sort=" + sort.field.toLowerCase();
                // opacité en fonction du rang de la clé de tri
                $("#dir_" + sort.field).css("opacity", 1 - sortIndex / 3);
                if (sort.desc) {
                    queryString += ',desc';
                    $("#dir_" + sort.field).addClass('glyphicon glyphicon-sort-by-attributes-alt');
                } else
                    $("#dir_" + sort.field).addClass('glyphicon glyphicon-sort-by-attributes');
                sortIndex++;
            });

            search = "";
            addSearchKey("title", $("#search_title").val());
            addSearchKey("username", $("#search_user").val());

            if (search != "") {
                if (queryString != "")
                    search = "&" + search;
                else
                    search = "?" + search;
            }
            queryString += search;
            updateUI();
        }

        function updateUI() {
            updateConnected();
            getphotos(true);
        }
        function getphotos(forceRefreshphotoList = false) {
            if (forceRefreshphotoList) {
                webAPI_GET_ALL(queryString, updateNewsList, AlertError);
            } else
                webAPI_HEAD(checkETag, AlertError);
        }
        function checkETag(ETag) {
            if (ETag != currentETag) {
                webAPI_GET_ALL(queryString, updateNewsList, AlertError);
            }
        }
        function createCssClass(name, rules) {
            var style = document.createElement('style');
            style.type = 'text/css';
            document.getElementsByTagName('head')[0].appendChild(style);
            if (!(style.sheet || {}).insertRule)
                (style.styleSheet || style.sheet).addRule(name, rules);
            else
                style.sheet.insertRule(name + "{" + rules + "}", 0);
        }

        function insertWaitingStatus() {
            $('#newsList').empty();
            $("#dialog-waiting").dialog('open');
        }
        function statusToString(status) {
            let text = "Le server ne répond pas.";
            switch (status) {
                case 401: text = "<br>Requête non autorisée. <br>Vous devez être connecté."; break;
                case 409: text = "<br>Conflit de données. <br>Requête refusée."; break;
                case 422: text = "<br>Format des données soumises incorrect. <br>Requête refusée."; break;
            }
            return text;
        }
        function closeAllDialog() {
            $(".dialog").dialog("close");
        }
        function forceLogout() {
            Alert("Expiration de permission d'accès. Vous n'êtes plus connecté.");
            closeAllDialog();
            deConnect();
            updateUI(true);
        }
        function Alert(message) {
            $.confirm({
                title: message,
                content: '',
                buttons: {
                    fermer: function () { }
                }
            });
        }
        function AlertError(status) {
            $.confirm({
                title: "Message provenant du server..." + status,
                content: '<img src="images/error.png" style="width:60px;margin:10px" alt="httpError"/>' + statusToString(status),
                buttons: {
                    fermer: function () {
                        this.close();
                        if (status == 401) {
                            forceLogout();
                        }
                        pausephotosListPeriodicRefresh = true;
                    }
                }
            });
        }

        function initNewsValidation() {
            newsValidationProvider = new ValidationProvider("newsForm");
            newsValidationProvider.addControl("newsTitle", validate_newsTitle, false /*validateOnLeave*/);
            newsValidationProvider.addControl("newsText", validate_newsText, false /*validateOnLeave*/);
        }
        function resetphotoValidation() {
            newsValidationProvider.reset();
        }
        function validate_newsTitle() {
            let TBX_Title = document.getElementById("newsTitle");
            if (TBX_Title.value === "")
                return "Titre manquant";
            return "";
        }
        function validate_newsText() {
            let TBX_Description = document.getElementById("newsText");
            if (TBX_Description.value === "")
                return "Texte manquant";
            return "";
        }
        function initProfilValidation() {
            profilValidationProvider = new ValidationProvider("profilForm");
            profilValidationProvider.addControl("profilUsername", validate_ProfilUsername, false /*validateOnLeave*/);
            profilValidationProvider.addControl("profilEmail", validate_ProfilEmail, false /*validateOnLeave*/);
            profilValidationProvider.addControl("profilPassword", validate_ProfilPassword, false /*validateOnLeave*/);
            profilValidationProvider.addControl("profilConfirmPassword", validate_ProfilConfirmPassword, false /*validateOnLeave*/);
        }
        function resetProfilValidation() {
            profilValidationProvider.reset();
        }
        function validate_ProfilUsername() {
            let TBX_Username = document.getElementById("profilUsername");
            if (TBX_Username.value === "")
                return "Nom d'usager manquant";
            return "";
        }
        function validate_ProfilEmail() {
            let TBX_Email = document.getElementById("profilEmail");
            let EmailRegex = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            if (TBX_Email.value === "")
                return "Courriel manquant";
            if (!EmailRegex.test(TBX_Email.value))
                return "Courriel invalide";
            return "";
        }
        function validate_ProfilPassword() {
            return "";
        }
        function validate_ProfilConfirmPassword() {
            let TBX_Password = document.getElementById("profilPassword");;
            let TBX_Confirm = document.getElementById("profilConfirmPassword");
            if (TBX_Password.value != "") {
                if (TBX_Confirm.value != TBX_Password.value)
                    return "Différent du mot de passe."
            }
            return "";
        }

        function cellOver(e) {
            if (!addMode && !editMode) {
                // currentTarget.className contient en principe : 'row_x cell ...'
                let photoId = e.currentTarget.className.split(' ')[0].split('_')[1];
                $('#edit_' + photoId).show();
                $('#delete_' + photoId).show();
                $('.row_' + photoId).addClass('selectedRow');
            }
        }
        function cellBlur(e) {
            if (!editMode) {
                // currentTarget.className contient en principe : 'row_x cell ...'
                let photoId = e.currentTarget.className.split(' ')[0].split('_')[1];
                $('#edit_' + photoId).hide();
                $('#delete_' + photoId).hide();
                $('.row_' + photoId).removeClass('selectedRow');
            }
        }
        function makeCell(content, cssClass) {
            return $('<div class= "' + cssClass + '">' + content + '</div>');
        }
        function makeButton(cssClass, id, tooltip) {
            return $('<span id="' + id + '" class="' + cssClass + '" style="margin-rigth:3px;"></span>');
        }
        function makeGlyphIcon(glyphIconId) {
            return $("<div class='gicon glyphicon glyphicon-" + glyphIconId + "'></div>");
        }
        function makeHyperLink(url, caption) {
            return '<a href="' + url + '"target="_blank">' + caption + '</a>';
        }
        function makeFavicon(url) {
            // Utiliser l'API de google pour extraire le favicon du site pointé par url
            // retourne un élément div comportant le favicon en tant qu'image de fond
            ///////////////////////////////////////////////////////////////////////////
            if (url.slice(-1) != '/') url += '/';
            url = "http://www.google.com/s2/favicons?sz=64&domain=" + url;
            return '<div class="favicon" style="background-image: url(' + url + ');"></div>';
        }
        function html_fittedAvatar(Avatar_url, css = '') {
            return "<div class='" + css + "' style='background:url(" + Avatar_url + ") no-repeat center; background-size: cover; margin-right:5px;'></div>";
        }
        function html_fittedImage(url, css = '') {
            return $(" <div class='" + css + "' style='background:url(" + url + ") no-repeat center; background-size: cover; margin-right:5px;'></div>");
        }

        function previewImageLink(url) {
            return $("<a href='" + url + "' target='_blank'></a>");
        }
        function post(news, loggedUserId) {
            let lorem = "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum."
            let showCRUD = 'hidden';
            showCRUD = 'visible';

            let postContainer = $("<div class='postContainer'></div>");
            let postLayout = $("<div class='postLayout' id='postLayout'></div>");
            let postUserInfo = $("<div class='postUserInfo' id='postUserInfo_" + news.Id + "'></div>");
            let postInfo = $("<div class='postInfo' id='postInfo_" + news.Id + "'></div>");
            let CRUDBtnContainer = $("<div class='postCRUDBtnContainer' id='postCRUDBtnContainer_" + news.Id + "'></div>")
            let avatarContainer = $("<div id='postAvatarContainer' class='postAvatarContainer'></div>");

            webAPI_getPostUserInfo(news.UserId, (user) => {
                avatarContainer.append("<div class='postAvatar' style='background:url(" + user.AvatarURL + ") no-repeat center; background-size: cover;''></div>");
                postUserInfo.append($("<p class='postUsername' id='postUsername_" + news.Id + "'>" + user.Name + "</p>"));
            });
            postInfo.append($("<p class='postTitle' id='photoTitle_" + news.Id + "'>" + news.Title + "</p>"));
            postInfo.append($("<div class='postImage' style='background:url(" + news.ImageURL + ") no-repeat center; background-size: cover; margin-right:5px;'></div>"));
            postInfo.append($("<div class='postDescription' id='postDescription_" + news.Id + "'>" + news.Text + "</div>"));



            const options = { /*weekday: 'long', */year: 'numeric', month: 'long', day: 'numeric' };
            //let image = html_fittedImage(photo.ThumbnailURL, "thumbnail");
            if (connected && news.UserId == loggedUserId) {
                showCRUD = 'visible';
                // Bouton d'appel à la modification de la photo
                $(CRUDBtnContainer).append(makeButton("editPost fa fa-pencil", "edit_" + news.Id, "Modifier " + news.Title));
                // Bouton d'appel au retrait de photo
                $(CRUDBtnContainer).append(makeButton("deletePost fa fa-eraser", "delete_" + news.Id, "Effacer " + news.Title));
            }

            postUserInfo.append(avatarContainer);
            postLayout.append(postUserInfo);
            postLayout.append(postInfo);
            postLayout.append(CRUDBtnContainer);
            postContainer.append(postLayout);
            //postContainer.append(previewImageLink(photo.OriginalURL).append(image));
            return postContainer;
        }

        function updateNewsList(news, ETag) {
            currentETag = ETag;
            $('#newsList').empty();
            let loggedUserId = (retrieveLoggedUser() ? retrieveLoggedUser().Id : null);
            if (loggedUserId) {
                news.forEach(n => {
                    $('#newsList').append(post(n, loggedUserId));
                });
                $('.editPost').click(OpenEditNewsDialog);
                $('.deletePost').click(deletephoto);
            }
            $("#dialog-waiting").dialog('close');
        }
    </script>
</body>

</html>